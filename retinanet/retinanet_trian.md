#-*- coding: utf-8 -*-
"""retinanet_trian.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1MClb81TzaN2A3-s7BbOqTsNKuXVPHRRF
"""
# 安装keras>=2.2.5
!pip list
!pip install -U keras

# 下载安装keras-retinanet

%cd '/content/drive/My Drive/Colab Notebooks/retinanet/'
!git clone https://github.com/fizyr/keras-retinanet.git
%cd keras-retinanet/
!pip install .

# 准备数据集
使用labelIMG标注，将图片与标注结果放在同一个文件夹

# 将标注的图片放到data文件夹，生成csv文件
!python xml2csv.py -i .

# 训练模型

!retinanet-train --steps 100 csv train.csv class.csv

# 转化为推断模型

## 若你已经安装了Retinanet库
retinanet-convert-model 训练出的模型地址 转化后的推断模型地址
retinanet-convert-model /path/to/training/model.h5 /path/to/save/inference/model.h5

## 若直接在文件夹中运行
keras_retinanet/bin/convert_model.py /path/to/training/model.h5 /path/to/save/inference/model.h5



# 模型测试

```
# import keras
import keras

# import keras_retinanet
from keras_retinanet import models
from keras_retinanet.utils.image import read_image_bgr, preprocess_image, resize_image
from keras_retinanet.utils.visualization import draw_box, draw_caption
from keras_retinanet.utils.colors import label_color
from keras_retinanet.utils.gpu import setup_gpu

# import miscellaneous modules
import matplotlib.pyplot as plt
import cv2
import os
import numpy as np
import time

# use this to change which GPU to use
gpu = 0

# set the modified tf session as backend in keras
setup_gpu(gpu)
# adjust this to point to your downloaded/trained model
# models can be downloaded here: https://github.com/fizyr/keras-retinanet/releases
model_path = 'mymodel.h5'

# load retinanet model
model = models.load_model(model_path)

# if the model is not converted to an inference model, use the line below
# see: https://github.com/fizyr/keras-retinanet#converting-a-training-model-to-inference-model
#model = models.convert_model(model)

#print(model.summary())

# load label to names mapping for visualization purposes
labels_to_names = {0:'duck',1:'pot', 2:'cup', 3:'drill'}

# load image
image = read_image_bgr('C:/Users/Zhang Lantao/Desktop/BOP_rgb/000006.png')

# copy to draw on
draw = image.copy()
draw = cv2.cvtColor(draw, cv2.COLOR_BGR2RGB)

# preprocess image for network
image = preprocess_image(image)
image, scale = resize_image(image)

# process image
start = time.time()
boxes, scores, labels = model.predict_on_batch(np.expand_dims(image, axis=0))
print("processing time: ", time.time() - start)

# correct for image scale
boxes /= scale

# visualize detections
for box, score, label in zip(boxes[0], scores[0], labels[0]):
    # scores are sorted so we can break
    if score < 0.5:
        break

    color = label_color(label)
    
    b = box.astype(int)
    draw_box(draw, b, color=color)
    
    caption = "{} {:.3f}".format(labels_to_names[label], score)
    draw_caption(draw, b, caption)

plt.figure(figsize=(15, 15))
plt.axis('off')
plt.imshow(draw)
plt.show()

```




# 高阶:
## 	关于模型的图片输入尺寸:

在https://github.com/fizyr/keras-retinanet/blob/master/keras_retinanet/bin/train.py中的409、410行有设置输入的默认参数（800*1333）：
parser.add_argument('--image-min-side',   help='Rescale the image so the smallest side is min_side.', type=int, default=800)
parser.add_argument('--image-max-side',   help='Rescale the image if the largest side is larger than max_side.', type=int, default=1333)

### 	未知：使用模型时可能也要设置尺寸





## 多卡训练：
python keras_retinanet/bin/train.py --multi-gpu-force --multi-gpu 2 --batch-size 2 csv train.csv classes.csv --val-annotations keras_retinanet/CSV/val_annotations.csv

## backbone

替换backbone可用如下命令（可选的包括vgg16，vgg19，resnet50，resnet101，densenet121，densenet169，densenet201）

~~~shell
python keras_retinanet/bin/train.py --steps 1000 --backbone vgg16 --gpu 2 csv keras_retinanet/CSV/train_annotations.csv keras_retinanet/CSV/classes.csv --val-annotations keras_retinanet/CSV/val_annotations.csv

~~~

